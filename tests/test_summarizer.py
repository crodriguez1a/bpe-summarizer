import re
import pytest

from summarizer.summarizer import bpe_summarize

@pytest.fixture(scope="session")
def scisummnet_sample() -> str:
    return "\n  Fluency Adequacy or HTER? Exploring Different Human Judgments with a Tunable MT Metric\n  \n    Automatic Machine Translation (MT) evaluation metrics have traditionally been evaluated by the correlation of the scores they assign to MT output with human judgments of translation performance.\n    Different types of human judgments, such as Fluency, Adequacy, and HTER, measure varying aspects of MT performance that can be captured by automatic MT metrics.\n    We explore these differences through the use of a new tunable MT metric: TER-Plus, which extends the Translation Edit Rate evaluation metric with tunable parameters and the incorporation of morphology, synonymy and paraphrases.\n    TER-Plus was shown to be one of the top metrics in NIST&#8217;s Metrics MATR 2008 Challenge, having the highest average rank in terms of Pearson and Spearman correlation.\n    Optimizing TER-Plus to different types of human judgments yields significantly improved correlations and meaningful changes in the weight of different types of edits, demonstrating significant differences between the types of human judgments.\n  \n  \n    Since the introduction of the BLEU metric (Papineni et al., 2002), statistical MT systems have moved away from human evaluation of their performance and towards rapid evaluation using automatic metrics.\n    These automatic metrics are themselves evaluated by their ability to generate scores for MT output that correlate well with human judgments of translation quality.\n    Numerous methods of judging MT output by humans have been used, including Fluency, Adequacy, and, more recently, Human-mediated Translation Edit Rate (HTER) (Snover et al., 2006).\n    Fluency measures whether a translation is fluent, regardless of the correct meaning, while Adequacy measures whether the translation conveys the correct meaning, even if the translation is not fully fluent.\n    Fluency and Adequacy are frequently measured together on a discrete 5 or 7 point scale, with their average being used as a single score of translation quality.\n    HTER is a more complex and semi-automatic measure in which humans do not score translations directly, but rather generate a new reference translation that is closer to the MT output but retains the fluency and meaning of the original reference.\n    This new targeted reference is then used as the reference translation when scoring the MT output using Translation Edit Rate (TER) (Snover et al., 2006) or when used with other automatic metrics such as BLEU or METEOR (Banerjee and Lavie, 2005).\n    One of the difficulties in the creation of targeted references is a further requirement that the annotator attempt to minimize the number of edits, as measured by TER, between the MT output and the targeted reference, creating the reference that is as close as possible to the MT output while still being adequate and fluent.\n    In this way, only true errors in the MT output are counted.\n    While HTER has been shown to be more consistent and finer grained than individual human annotators of Fluency and Adequacy, it is much more time consuming and taxing on human annotators than other types of human judgments, making it difficult and expensive to use.\n    In addition, because HTER treats all edits equally, no distinction is made between serious errors (errors in names or missing subjects) and minor edits (such as a difference in verb agreement or a missing determinator).\n    Different types of translation errors vary in importance depending on the type of human judgment being used to evaluate the translation.\n    For example, errors in tense might barely affect the adequacy of a translation but might cause the translation be scored as less fluent.\n    On the other hand, deletion of content words might not lower the fluency of a translation but the adequacy would suffer.\n    In this paper, we examine these differences by taking an automatic evaluation metric and tuning it to these these human judgments and examining the resulting differences in the parameterization of the metric.\n    To study this we introduce a new evaluation metric, TER-Plus (TERp)1 that improves over the existing Translation Edit Rate (TER) metric (Snover et al., 2006), incorporating morphology, synonymy and paraphrases, as well as tunable costs for different types of errors that allow for easy interpretation of the differences between human judgments.\n    Section 2 summarizes the TER metric and discusses how TERp improves on it.\n    Correlation results with human judgments, including independent results from the 2008 NIST Metrics MATR evaluation, where TERp was consistently one of the top metrics, are presented in Section 3 to show the utility of TERp as an evaluation metric.\n    The generation of paraphrases, as well as the effect of varying the source of paraphrases, is discussed in Section 4.\n    Section 5 discusses the results of tuning TERp to Fluency, Adequacy and HTER, and how this affects the weights of various edit types.\n  \n  \n    Both TER and TERp are automatic evaluation metrics for machine translation that score a translation, the hypothesis, of a foreign language text, the source, against a translation of the source text that was created by a human translator, called a reference translation.\n    The set of possible correct translations is very large&#8212;possibly infinite&#8212; and any single reference translation is just a single point in that space.\n    Usually multiple reference translations, typically 4, are provided to give broader sampling of the space of correct translations.\n    Automatic MT evaluation metrics compare the hypothesis against this set of reference translations and assign a score to the similarity; higher scores are given to hypotheses that are more similar to the references.\n    In addition to assigning a score to a hypothesis, the TER metric also provides an alignment between the hypothesis and the reference, enabling it to be useful beyond general translation evaluation.\n    While TER has been shown to correlate well with human judgments of translation quality, it has several flaws, including the use of only a single reference translation and the measuring of similarity only by exact word matches between the hypothesis and the reference.\n    The handicap of using a single reference can be addressed by the construction of a lattice of reference translations.\n    Such a technique has been used with TER to combine the output of multiple translation systems (Rosti et al., 2007).\n    TERp does not utilize this methodology2 and instead focuses on addressing the exact matching flaw of TER.\n    A brief description of TER is presented in Section 2.1, followed by a discussion of how TERp differs from TER in Section 2.2.\n    One of the first automatic metrics used to evaluate automatic machine translation (MT) systems was Word Error Rate (WER) (Niessen et al., 2000), which is the standard evaluation metric for Automatic Speech Recognition.\n    WER is computed as the Levenshtein (Levenshtein, 1966) distance between the words of the system output and the words of the reference translation divided by the length of the reference translation.\n    Unlike speech recognition, there are many correct translations for any given foreign sentence.\n    These correct translations differ not only in their word choice but also in the order in which the words occur.\n    WER is generally seen as inadequate for evaluation for machine translation as it fails to combine knowledge from multiple reference translations and also fails to model the reordering of words and phrases in translation.\n    TER addresses the latter failing of WER by allowing block movement of words, called shifts. within the hypothesis.\n    Shifting a phrase has the same edit cost as inserting, deleting or substituting a word, regardless of the number of words being shifted.\n    While a general solution to WER with block movement is NP-Complete (Lopresti and Tomkins, 1997), TER addresses this by using a greedy search to select the words to be shifted, as well as further constraints on the words to be shifted.\n    These constraints are intended to simulate the way in which a human editor might choose the words to shift.\n    For exact details on these constraints, see Snover et al. (2006).\n    There are other automatic metrics that follow the general formulation as TER but address the complexity of shifting in different ways, such as the CDER evaluation metric (Leusch et al., 2006).\n    When TER is used with multiple references, it does not combine the references.\n    Instead, it scores the hypothesis against each reference individually.\n    The reference against which the hypothesis has the fewest number of edits is deemed the closet reference, and that number of edits is used as the numerator for calculating the TER score.\n    For the denominator, TER uses the average number of words across all the references.\n    TER-Plus (TERp) is an extension of TER that aligns words in the hypothesis and reference not only when they are exact matches but also when the words share a stem or are synonyms.\n    In addition, it uses probabilistic phrasal substitutions to align phrases in the hypothesis and reference.\n    These phrases are generated by considering possible paraphrases of the reference words.\n    Matching using stems and synonyms (Banerjee and Lavie, 2005) and using paraphrases (Zhou et al., 2006; Kauchak and Barzilay, 2006) have previously been shown to be beneficial for automatic MT evaluation.\n    Paraphrases have also been shown to be useful in expanding the number of references used for parameter tuning (Madnani et al., 2007; Madnani et al., 2008) although they are not used directly in this fashion within TERp.\n    While all edit costs in TER are constant, all edit costs in TERp are optimized to maximize correlation with human judgments.\n    This is because while a set of constant weights might prove adequate for the purpose of measuring translation quality&#8212;as evidenced by correlation with human judgments both for TER and HTER&#8212;they may not be ideal for maximizing correlation.\n    TERp uses all the edit operations of TER&#8212; Matches, Insertions, Deletions, Substitutions and Shifts&#8212;as well as three new edit operations: Stem Matches, Synonym Matches and Phrase Substitutions.\n    TERp identifies words in the hypothesis and reference that share the same stem using the Porter stemming algorithm (Porter, 1980).\n    Two words are determined to be synonyms if they share the same synonym set according to WordNet (Fellbaum, 1998).\n    Sequences of words in the reference are considered to be paraphrases of a sequence of words in the hypothesis if that phrase pair occurs in the TERp phrase table.\n    The TERp phrase table is discussed in more detail in Section 4.\n    With the exception of the phrase substitutions, the cost for all other edit operations is the same regardless of what the words in question are.\n    That is, once the edit cost of an operation is determined via optimization, that operation costs the same no matter what words are under consideration.\n    The cost of a phrase substitution, on the other hand, is a function of the probability of the paraphrase and the number of edits needed to align the two phrases according to TERp.\n    In effect, the probability of the paraphrase is used to determine how much to discount the alignment of the two phrases.\n    Specifically, the cost of a phrase substitution between the reference phrase, p1 and the hypothesis phrase p2 is: where w1, w2, w3, and w4 are the 4 free parameters of the edit cost, edit(p1,p2) is the edit cost according to TERp of aligning p1 to p2 (excluding phrase substitutions) and Pr(p1,p2) is the probability of paraphrasing p1 as p2, obtained from the TERp phrase table.\n    The w parameters of the phrase substitution cost may be negative while still resulting in a positive phrase substitution cost, as w2 is multiplied by the log probability, which is always a negative number.\n    In practice this term will dominate the phrase substitution edit cost.\n    This edit cost for phrasal substitutions is, therefore, specified by four parameters, w1, w2, w3 and w4.\n    Only paraphrases specified in the TERp phrase table are considered for phrase substitutions.\n    In addition, the cost for a phrasal substitution is limited to values greater than or equal to 0, i.e., the substitution cost cannot be negative.\n    In addition, the shifting constraints of TERp are also relaxed to allow shifting of paraphrases, stems, and synonyms.\n    In total TERp uses 11 parameters out of which four represent the cost of phrasal substitutions.\n    The match cost is held fixed at 0, so that only the 10 other parameters can vary during optimization.\n    All edit costs, except for the phrasal substitution parameters, are also restricted to be positive.\n    A simple hill-climbing search is used to optimize the edit costs by maximizing the correlation of human judgments with the TERp score.\n    These correlations are measured at the sentence, or segment, level.\n    Although it was done for the experiments described in this paper, optimization could also be performed to maximize document level correlation &#8211; such an optimization would give decreased weight to shorter segments as compared to the segment level optimization.\n  \n  \n    The optimization of the TERp edit costs, and comparisons against several standard automatic evaluation metrics, using human judgments of Adequacy is first described in Section 3.1.\n    We then summarize, in Section 3.2, results of the NIST Metrics MATR workshop where TERp was evaluated as one of 39 automatic metrics using many test conditions and types of human judgments.\n    As part of the 2008 NIST Metrics MATR workshop (Przybocki et al., 2008), a development subset of translations from eight Arabic-to-English MT systems submitted to NIST&#8217;s MTEval 2006 was released that had been annotated for Adequacy.\n    We divided this development set into an optimization set and a test set, which we then used to optimize the edit costs of TERp and compare it against other evaluation metrics.\n    TERp was optimized to maximize the segment level Pearson correlation with adequacy on the optimization set.\n    The edit costs determined by this optimization are shown in Table 1.\n    We can compare TERp with other metrics by comparing their Pearson and Spearman correlations with Adequacy, at the segment, document and system level.\n    Document level Adequacy scores are determined by taking the length weighted average of the segment level scores.\n    System level scores are determined by taking the weighted average of the document level scores in the same manner.\n    We compare TERp with BLEU (Papineni et al., 2002), METEOR (Banerjee and Lavie, 2005), and TER (Snover et al., 2006).\n    The IBM version of BLEU was used in case insensitive mode with an ngram-size of 4 to calculate the BLEU scores.\n    Case insensitivity was used with BLEU as it was found to have much higher correlation with Adequacy.\n    In addition, we also examined BLEU using an ngram-size of 2 (labeled as BLEU-2), instead of the default ngram-size of 4, as it often has a higher correlation with human judgments.\n    When using METEOR, the exact matching, porter stemming matching, and WordNet synonym matching modules were used.\n    TER was also used in case insensitive mode.\n    We show the Pearson and Spearman correlation numbers of TERp and the other automatic metrics on the optimization set and the test set in Tables 2 and 3.\n    Correlation numbers that are statistically indistinguishable from the highest correlation, using a 95% confidence interval, are shown in bold and numbers that are actually not statistically significant correlations are marked with a &#8224;.\n    TERp has the highest Pearson correlation in all conditions, although not all differences are statistically significant.\n    When examining the Spearman correlation, TERp has the highest correlation on the segment and system levels, but performs worse than METEOR on the document level Spearman correlatons.\n    TERp was one of 39 automatic metrics evaluated in the 2008 NIST Metrics MATR Challenge.\n    In order to evaluate the state of automatic MT evaluation, NIST tested metrics across a number of conditions across 8 test sets.\n    These conditions included segment, document and system level correlations with human judgments of preference, fluency, adequacy and HTER.\n    The test sets included translations from Arabic-to-English, Chinese-toEnglish, Farsi-to-English, Arabic-to-French, and English-to-French MT systems involved in NIST&#8217;s MTEval 2008, the GALE (Olive, 2005) Phase 2 and Phrase 2.5 program, Transtac January and July 2007, and CESTA run 1 and run 2, covering multiple genres.\n    The version of TERp submitted to this workshop was optimized as described in Section 3.1.\n    The development data upon which TERp was optimized was not part of the test sets evaluated in the Challenge.\n    Due to the wealth of testing conditions, a simple overall view of the official MATR08 results released by NIST is difficult.\n    To facilitate this analysis, we examined the average rank of each metric across all conditions, where the rank was determined by their Pearson and Spearman correlation with human judgments.\n    To incorporate statistical significance, we calculated the 95% confidence interval for each correlation coefficient and found the highest and lowest rank from which the correlation coefficient was statistically indistinguishable, resulting in lower and upper bounds of the rank for each metric in each condition.\n    The average lower bound, actual, and upper bound ranks (where a rank of 1 indicates the highest correlation) of the top metrics, as well as BLEU and TER, are shown in Table 4, sorted by the average upper bound Pearson correlation.\n    Full descriptions of the other metrics3, the evaluation results, and the test set composition are available from NIST (Przybocki et al., 2008).\n    This analysis shows that TERp was consistently one of the top metrics across test conditions and had the highest average rank both in terms of Pearson and Spearman correlations.\n    While this analysis is not comprehensive, it does give a general idea of the performance of all metrics by synthesizing the results into a single table.\n    There are striking differences between the Spearman and Pearson correlations for other metrics, in particular the CDER metric (Leusch et al., 2006) had the second highest rank in Spearman correlations (after TERp), but was the sixth ranked metric according to the Pearson correlation.\n    In several cases, TERp was not the best metric (if a metric was the best in all conditions, its average rank would be 1), although it performed well on average.\n    In particular, TERp did significantly better than the TER metric, indicating the benefit of the enhancements made to TER.\n  \n  \n    TERp uses probabilistic phrasal substitutions to align phrases in the hypothesis with phrases in the reference.\n    It does so by looking up&#8212;in a precomputed phrase table&#8212;paraphrases of phrases in the reference and using its associated edit cost as the cost of performing a match against the hypothesis.\n    The paraphrases used in TERp were extracted using the pivot-based method as described in (Bannard and Callison-Burch, 2005) with several additional filtering mechanisms to increase the precision.\n    The pivot-based method utilizes the inherent monolingual semantic knowledge from bilingual corpora: we first identify English-to-F phrasal correspondences, then map from English to English by following translation units from English to F and back.\n    For example, if the two English phrases e1 and e2 both correspond to the same foreign phrase f, then they may be considered to be paraphrases of each other with the following probability: If there are several pivot phrases that link the two English phrases, then they are all used in computing the probability: The corpus used for extraction was an ArabicEnglish newswire bitext containing a million sentences.\n    A few examples of the extracted paraphrase pairs that were actually used in a run of TERp on the Metrics MATR 2008 development set are shown below: (brief -* short) (controversy over -* polemic about) (by using power -* by force) (response -* reaction) A discussion of paraphrase quality is presented in Section 4.1, followed by a brief analysis of the effect of varying the pivot corpus used by the automatic paraphrase generation upon the correlation performance of the TERp metric in Section 4.2.\n    We analyzed the utility of the paraphrase probability and found that it was not always a very reliable estimate of the degree to which the pair was semantically related.\n    For example, we looked at all paraphrase pairs that had probabilities greater than 0.9, a set that should ideally contain pairs that are paraphrastic to a large degree.\n    In our analysis, we found the following five kinds of paraphrases in this set: pairs only differ in the morphological form for one of the words.\n    As the examples show, any knowledge that these pairs may provide is already available to TERp via stemming.\n    (50 ton &#8594; 50 tons) (caused clouds &#8594; causing clouds) (syria deny &#8594; syria denies) Given this distribution of the pivot-based paraphrases, we experimented with a variant of TERp that did not use the paraphrase probability at all but instead only used the actual edit distance between the two phrases to determine the final cost of a phrase substitution.\n    The results for this experiment are shown in the second row of Table 5.\n    We can see that this variant works as well as the full version of TERp that utilizes paraphrase probabilities.\n    This confirms our intuition that the probability computed via the pivot-method is not a very useful predictor of semantic equivalence for use in TERp.\n    To determine the effect that the pivot language might have on the quality and utility of the extracted paraphrases in TERp, we used paraphrase pairsmade available by Callison-Burch (2008).\n    These paraphrase pairs were extracted from Europarl data using each of 10 European languages (German, Italian, French etc.) as a pivot language separately and then combining the extracted paraphrase pairs.\n    Callison-Burch (2008) also extracted and made available syntactically constrained paraphrase pairs from the same data that are more likely to be semantically related.\n    We used both sets of paraphrases in TERp as alternatives to the paraphrase pairs that we extracted from the Arabic newswire bitext.\n    The results are shown in the last four rows of Table 5 and show that using a pivot language other than the one that the MT system is actually translating yields results that are almost as good.\n    It also shows that the syntactic constraints imposed by Callison-Burch (2008) on the pivot-based paraphrase extraction process are useful and yield improved results over the baseline pivot-method.\n    The results further support our claim that the pivot paraphrase probability is not a very useful indicator of semantic relatedness.\n  \n  \n    To evaluate the differences between human judgment types we first align the hypothesis to the references using a fixed set of edit costs, identical to the weights in Table 1, and then optimize the edit costs to maximize the correlation, without realigning.\n    The separation of the edit costs used for alignment from those used for scoring allows us to remove the confusion of edit costs selected for alignment purposes from those selected to increase correlation.\n    For Adequacy and Fluency judgments, the MTEval 2002 human judgement set4 was used.\n    This set consists of the output of ten MT systems, 3 Arabic-to-English systems and 7 Chineseto-English systems, consisting of a total, across all systems and both language pairs, of 7,452 segments across 900 documents.\n    To evaluate HTER, the GALE (Olive, 2005) 2007 (Phase 2.0) HTER scores were used.\n    This set consists of the output of 6 MT systems, 3 Arabic-to-English systems and 3 Chinese-to-English systems, although each of the systems in question is the product of system combination.\n    The HTER data consisted of a total, across all systems and language pairs, of 16,267 segments across a total of 1,568 documents.\n    Because HTER annotation is especially expensive and difficult, it is rarely performed, and the only source, to the authors&#8217; knowledge, of available HTER annotations is on GALE evaluation data for which no Fluency and Adequacy judgments have been made publicly available.\n    The edit costs learned for each of these human judgments, along with the alignment edit costs are shown in Table 6.\n    While all three types of human judgements differ from the alignment costs used in alignment, the HTER edit costs differ most significantly.\n    Unlike Adequacy and Fluency which have a low edit cost for insertions and a very high cost for deletions, HTER has a balanced cost for the two edit types.\n    Inserted words are strongly penalized against in HTER, as opposed to in Adequacy and Fluency, where such errors are largely forgiven.\n    Stem and synonym edits are also penalized against while these are considered equivalent to a match for both Adequacy and Fluency.\n    This penalty against stem matches can be attributed to Fluency requirements in HTER that specifically penalize against incorrect morphology.\n    The cost of shifts is also increased in HTER, strongly penalizing the movement of phrases within the hypothesis, while Adequacy and Fluency give a much lower cost to such errors.\n    Some of the differences between HTER and both fluency and adequacy can be attributed to the different systems used.\n    The MT systems evaluated with HTER are all highly performing state of the art systems, while the systems used for adequacy and fluency are older MT systems.\n    The differences between Adequacy and Fluency are smaller, but there are still significant differences.\n    In particular, the cost of shifts is over twice as high for the fluency optimized system than the adequacy optimized system, indicating that the movement of phrases, as expected, is only slightly penalized when judging meaning, but can be much more harmful to the fluency of a translation.\n    Fluency however favors paraphrases more strongly than the edit costs optimized for adequacy.\n    This might indicate that paraphrases are used to generate a more fluent translation although at the potential loss of meaning.\n  \n  \n    We introduced a new evaluation metric, TER-Plus, and showed that it is competitive with state-of-theart evaluation metrics when its predictions are correlated with human judgments.\n    The inclusion of stem, synonym and paraphrase edits allows TERp to overcome some of the weaknesses of the TER metric and better align hypothesized translations with reference translations.\n    These new edit costs can then be optimized to allow better correlation with human judgments.\n    In addition, we have examined the use of other paraphrasing techniques, and shown that the paraphrase probabilities estimated by the pivot-method may not be fully adequate for judgments of whether a paraphrase in a translation indicates a correct translation.\n    This line of research holds promise as an external evaluation method of various paraphrasing methods.\n    However promising correlation results for an evaluation metric may be, the evaluation of the final output of an MT system is only a portion of the utility of an automatic translation metric.\n    Optimization of the parameters of an MT system is now done using automatic metrics, primarily BLEU.\n    It is likely that some features that make an evaluation metric good for evaluating the final output of a system would make it a poor metric for use in system tuning.\n    In particular, a metric may have difficulty distinguishing between outputs of an MT system that been optimized for that same metric.\n    BLEU, the metric most frequently used to optimize systems, might therefore perform poorly in evaluation tasks compared to recall oriented metrics such as METEOR and TERp (whose tuning in Table 1 indicates a preference towards recall).\n    Future research into the use of TERp and other metrics as optimization metrics is needed to better understand these metrics and the interaction with parameter optimization.\n    Finally, we explored the difference between three types of human judgments that are often used to evaluate both MT systems and automatic metrics, by optimizing TERp to these human judgments and examining the resulting edit costs.\n    While this can make no judgement as to the preference of one type of human judgment over another, it indicates differences between these human judgment types, and in particular the difference between HTER and Adequacy and Fluency.\n    This exploration is limited by the the lack of a large amount of diverse data annotated for all human judgment types, as well as the small number of edit types used by TERp.\n    The inclusion of additional more specific edit types could lead to a more detailed understanding of which translation phenomenon and translation errors are most emphasized or ignored by which types of human judgments.\n  \n  \n    This work was supported, in part, by BBN Technologies under the GALE Program, DARPA/IPTO Contract No.\n    HR0011-06-C-0022 and in part by the Human Language Technology Center of Excellence.. TERp is available on the web for download at: http://www.umiacs.umd.edu/&#8764;snover/terp/.\n  \n\n"

def test_summarizer(scisummnet_sample: str):
    result = bpe_summarize(scisummnet_sample[:1024], percentile=70)
    result = re.sub(r"\n|\s{2,99}", "", result)

    expected = "Exploring Different Human Judgments with a Tunable MT MetricAutomatic Machine Translation (MT) evaluation metrics have traditionally been evaluated by the correlation of the scores they assign to MT output with human judgments of translation performance. We explore these differences through the use of a new tunable MT metric: TER-Plus, which extends the Translation Edit Rate evaluation metric with tunable parameters and the incorporation of morphology, synonymy and paraphrases. Optimizing TER-Plus to different types of human judgments yields significantly improved correlations and meaningful changes in the weight of different types"
    assert result == expected
